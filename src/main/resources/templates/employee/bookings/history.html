<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{employee/layout :: layout(~{::title}, ~{::main})}">

<head>
    <title>Booking History - CarWash Employee Dashboard</title>
</head>

<main>
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-0">
                            <i class="fas fa-history me-2 text-primary"></i>
                            Booking History
                        </h2>
                        <p class="text-muted mb-0">Track and analyze booking performance</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success" onclick="exportHistory()">
                            <i class="fas fa-download me-1"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-chart-bar me-1"></i> Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-search me-2"></i>Search & Filter
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="searchInput" class="form-label">Search</label>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Customer name, booking ID..." onkeyup="filterBookings()">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select" id="statusFilter" onchange="filterBookings()">
                                    <option value="">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="no-show">No Show</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="serviceFilter" class="form-label">Service</label>
                                <select class="form-select" id="serviceFilter" onchange="filterBookings()">
                                    <option value="">All Services</option>
                                    <option value="basic">Basic Wash</option>
                                    <option value="premium">Premium Wash</option>
                                    <option value="deluxe">Deluxe Wash</option>
                                    <option value="interior">Interior Cleaning</option>
                                    <option value="engine">Engine Bay</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="dateFrom" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="dateFrom" onchange="filterBookings()">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="dateTo" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="dateTo" onchange="filterBookings()">
                            </div>
                            <div class="col-md-1 mb-3 d-flex align-items-end">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Total Bookings
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalBookings">1,247</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Completion Rate
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="completionRate">94.2%</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-percentage fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    Avg Service Time
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgServiceTime">47 min</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Total Revenue
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalRevenue">Rp 156M</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Charts -->
        <div class="row mb-4">
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">Weekly Performance</h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow">
                                <div class="dropdown-header">Period:</div>
                                <a class="dropdown-item" href="#">This Week</a>
                                <a class="dropdown-item" href="#">Last Week</a>
                                <a class="dropdown-item" href="#">This Month</a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Service Distribution</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie pt-4 pb-2">
                            <canvas id="serviceChart"></canvas>
                        </div>
                        <div class="mt-4 text-center small">
                            <span class="mr-2">
                                <i class="fas fa-circle text-primary"></i> Premium Wash
                            </span>
                            <span class="mr-2">
                                <i class="fas fa-circle text-success"></i> Basic Wash
                            </span>
                            <span class="mr-2">
                                <i class="fas fa-circle text-info"></i> Deluxe Wash
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking History Table -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">Booking History</h6>
                        <span class="badge bg-primary" id="resultCount">Showing 50 results</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="historyTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Date & Time</th>
                                        <th>Customer</th>
                                        <th>Service</th>
                                        <th>Vehicle</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Amount</th>
                                        <th>Rating</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- History data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Booking history pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .border-left-primary {
            border-left: 0.25rem solid #4e73df !important;
        }
        .border-left-success {
            border-left: 0.25rem solid #1cc88a !important;
        }
        .border-left-info {
            border-left: 0.25rem solid #36b9cc !important;
        }
        .border-left-warning {
            border-left: 0.25rem solid #f6c23e !important;
        }
        .chart-area {
            position: relative;
            height: 320px;
            width: 100%;
        }
        .chart-pie {
            position: relative;
            height: 15rem;
            width: 100%;
        }
        .rating-stars {
            color: #ffc107;
        }
    </style>

    <script>
        // Sample booking history data
        const bookingHistory = [
            {
                id: 'BK001',
                date: '2024-01-15',
                time: '09:00',
                customer: 'John Doe',
                service: 'Premium Wash',
                vehicle: 'Honda Civic (B1234XYZ)',
                duration: '45 min',
                status: 'completed',
                amount: 'Rp 150.000',
                rating: 5
            },
            {
                id: 'BK002',
                date: '2024-01-15',
                time: '10:30',
                customer: 'Jane Smith',
                service: 'Basic Wash',
                vehicle: 'Toyota Avanza (D5678ABC)',
                duration: '30 min',
                status: 'completed',
                amount: 'Rp 75.000',
                rating: 4
            },
            {
                id: 'BK003',
                date: '2024-01-14',
                time: '14:00',
                customer: 'Mike Johnson',
                service: 'Deluxe Wash + Wax',
                vehicle: 'BMW X5 (F9012DEF)',
                duration: '90 min',
                status: 'completed',
                amount: 'Rp 250.000',
                rating: 5
            },
            {
                id: 'BK004',
                date: '2024-01-14',
                time: '11:15',
                customer: 'Sarah Wilson',
                service: 'Interior Cleaning',
                vehicle: 'Suzuki Swift (G3456HIJ)',
                duration: '60 min',
                status: 'cancelled',
                amount: 'Rp 0',
                rating: 0
            },
            {
                id: 'BK005',
                date: '2024-01-13',
                time: '16:30',
                customer: 'David Brown',
                service: 'Engine Bay Cleaning',
                vehicle: 'Mercedes C-Class (K7890LMN)',
                duration: '75 min',
                status: 'completed',
                amount: 'Rp 200.000',
                rating: 4
            }
        ];

        let filteredHistory = [...bookingHistory];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeDateFilters();
            loadBookingHistory();
            initializeCharts();
        });

        function initializeDateFilters() {
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('dateFrom').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
        }

        function loadBookingHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            filteredHistory.forEach(booking => {
                const row = document.createElement('tr');
                
                const statusBadge = getStatusBadge(booking.status);
                const ratingStars = getRatingStars(booking.rating);
                const actionButtons = getHistoryActionButtons(booking);

                row.innerHTML = `
                    <td><strong>${booking.id}</strong></td>
                    <td>${formatDateTime(booking.date, booking.time)}</td>
                    <td>${booking.customer}</td>
                    <td>${booking.service}</td>
                    <td>${booking.vehicle}</td>
                    <td>${booking.duration}</td>
                    <td>${statusBadge}</td>
                    <td><strong>${booking.amount}</strong></td>
                    <td>${ratingStars}</td>
                    <td>${actionButtons}</td>
                `;

                tbody.appendChild(row);
            });

            updateResultCount();
        }

        function formatDateTime(date, time) {
            const dateObj = new Date(date);
            const dateStr = dateObj.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
            return `${dateStr}<br><small class="text-muted">${time}</small>`;
        }

        function getStatusBadge(status) {
            const badges = {
                'completed': '<span class="badge bg-success">Completed</span>',
                'cancelled': '<span class="badge bg-danger">Cancelled</span>',
                'no-show': '<span class="badge bg-warning">No Show</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
        }

        function getRatingStars(rating) {
            if (rating === 0) return '<span class="text-muted">No Rating</span>';
            
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star rating-stars"></i>';
                } else {
                    stars += '<i class="far fa-star text-muted"></i>';
                }
            }
            return stars;
        }

        function getHistoryActionButtons(booking) {
            return `
                <button class="btn btn-sm btn-outline-info me-1" onclick="viewBookingDetails('${booking.id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="printInvoice('${booking.id}')">
                    <i class="fas fa-print"></i>
                </button>
            `;
        }

        function filterBookings() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredHistory = bookingHistory.filter(booking => {
                // Search filter
                const matchesSearch = booking.customer.toLowerCase().includes(searchTerm) ||
                                    booking.id.toLowerCase().includes(searchTerm) ||
                                    booking.vehicle.toLowerCase().includes(searchTerm);

                // Status filter
                const matchesStatus = !statusFilter || booking.status === statusFilter;

                // Service filter
                const matchesService = !serviceFilter || booking.service.toLowerCase().includes(serviceFilter);

                // Date filter
                const bookingDate = new Date(booking.date);
                const fromDate = dateFrom ? new Date(dateFrom) : null;
                const toDate = dateTo ? new Date(dateTo) : null;
                
                const matchesDate = (!fromDate || bookingDate >= fromDate) &&
                                  (!toDate || bookingDate <= toDate);

                return matchesSearch && matchesStatus && matchesService && matchesDate;
            });

            loadBookingHistory();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('serviceFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            filteredHistory = [...bookingHistory];
            loadBookingHistory();
        }

        function updateResultCount() {
            document.getElementById('resultCount').textContent = `Showing ${filteredHistory.length} results`;
        }

        function viewBookingDetails(bookingId) {
            const booking = bookingHistory.find(b => b.id === bookingId);
            if (booking) {
                alert(`Booking Details:\n\nID: ${booking.id}\nDate: ${booking.date} ${booking.time}\nCustomer: ${booking.customer}\nService: ${booking.service}\nVehicle: ${booking.vehicle}\nDuration: ${booking.duration}\nStatus: ${booking.status}\nAmount: ${booking.amount}\nRating: ${booking.rating}/5`);
            }
        }

        function printInvoice(bookingId) {
            showToast(`Printing invoice for booking ${bookingId}...`, 'info');
        }

        function exportHistory() {
            showToast('Exporting booking history to Excel...', 'info');
        }

        function generateReport() {
            showToast('Generating performance report...', 'info');
        }

        function initializeCharts() {
            // Performance Chart (Line Chart)
            const performanceCtx = document.getElementById('performanceChart');
            if (performanceCtx) {
                // Placeholder for Chart.js implementation
                performanceCtx.getContext('2d');
                // Chart will be implemented when Chart.js is available
            }

            // Service Distribution Chart (Pie Chart)
            const serviceCtx = document.getElementById('serviceChart');
            if (serviceCtx) {
                // Placeholder for Chart.js implementation
                serviceCtx.getContext('2d');
                // Chart will be implemented when Chart.js is available
            }
        }

        function showToast(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
    </script>
</main>
</html>
