<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{customer/layout :: head}">
    <title>Booking Details</title>
    <style>
        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-confirmed { background-color: #d1fae5; color: #065f46; }
        .status-in_progress { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #f3e8ff; color: #7c3aed; }
        .status-cancelled { background-color: #fee2e2; color: #dc2626; }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .detail-item {
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
        }
        
        .payment-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-danger {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div th:replace="~{customer/layout :: layout('Booking Details', ~{::section})}">
        <section>
            <div class="p-6 max-w-4xl mx-auto">
                <!-- Alert Messages -->
                <div th:if="${success}" class="alert alert-success">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span th:text="${success}"></span>
                </div>
                
                <div th:if="${error}" class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span th:text="${error}"></span>
                </div>
                
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Booking Details</h1>
                        <p class="text-gray-600 mt-1" th:text="'Booking ID: CW-' + ${booking.idBooking}">Booking ID</p>
                    </div>
                    <span class="status-badge" 
                          th:classappend="${booking.status.name() == 'CONFIRMED'} ? 'status-confirmed' : 
                                         (${booking.status.name() == 'PENDING'} ? 'status-pending' : 
                                         (${booking.status.name() == 'IN_PROGRESS'} ? 'status-in_progress' : 
                                         (${booking.status.name() == 'COMPLETED'} ? 'status-completed' : 'status-cancelled')))"
                          th:text="${#strings.capitalize(#strings.toLowerCase(booking.status.name()))}">Status</span>
                </div>

                <!-- Service Information -->
                <div class="detail-card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-spray-can mr-2 text-blue-600"></i>
                        Service Information
                    </h2>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Service Type</div>
                            <div class="detail-value" th:text="${booking.service.serviceName}">Service Name</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Price</div>
                            <div class="detail-value" th:text="'Rp ' + ${#numbers.formatInteger(booking.service.price, 0, 'COMMA')}">Price</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Estimated Duration</div>
                            <div class="detail-value" th:text="${booking.service.estimatedDurationMinutes} + ' minutes'">Duration</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Booking Method</div>
                            <div class="detail-value" th:text="${#strings.capitalize(#strings.toLowerCase(booking.metode.name()))}">Method</div>
                        </div>
                    </div>
                    
                    <div th:if="${booking.service.description}" class="mt-4">
                        <div class="detail-label">Service Description</div>
                        <div class="detail-value" th:text="${booking.service.description}">Description</div>
                    </div>
                </div>

                <!-- Schedule Information -->
                <div class="detail-card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-calendar-check mr-2 text-green-600"></i>
                        Schedule Information
                    </h2>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Date</div>
                            <div class="detail-value" th:text="${#temporals.format(booking.tanggal, 'EEEE, MMMM dd, yyyy')}">Date</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Time</div>
                            <div class="detail-value" th:text="${#temporals.format(booking.jam, 'HH:mm')}">Time</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Booked On</div>
                            <div class="detail-value" th:text="${#temporals.format(booking.createdAt, 'MMM dd, yyyy HH:mm')}">Created Date</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Last Updated</div>
                            <div class="detail-value" th:text="${#temporals.format(booking.updatedAt, 'MMM dd, yyyy HH:mm')}">Updated Date</div>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Information -->
                <div class="detail-card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-car mr-2 text-purple-600"></i>
                        Vehicle Information
                    </h2>
                      <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Brand & Model</div>
                            <div class="detail-value" th:text="${booking.vehicleBrand != null and booking.vehicleModel != null ? booking.vehicleBrand + ' ' + booking.vehicleModel : 'Not specified'}">Brand Model</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">License Plate</div>
                            <div class="detail-value" th:text="${booking.licensePlate ?: 'Not specified'}">License Plate</div>
                        </div>
                        
                        <div class="detail-item">
                            <div class="detail-label">Color</div>
                            <div class="detail-value" th:text="${booking.vehicleColor ?: 'Not specified'}">Color</div>
                        </div>
                    </div>
                    
                    <div th:if="${booking.catatan}" class="mt-4">
                        <div class="detail-label">Special Notes</div>
                        <div class="detail-value" th:text="${booking.catatan}">Notes</div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="detail-card" th:if="${transfer}">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-credit-card mr-2 text-yellow-600"></i>
                        Payment Information
                    </h2>
                    
                    <div class="payment-info">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Payment Status</div>
                                <div class="detail-value" th:text="${#strings.capitalize(#strings.toLowerCase(transfer.status.name()))}">Payment Status</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">Amount</div>
                                <div class="detail-value" th:text="'Rp ' + ${#numbers.formatInteger(transfer.jumlah, 0, 'COMMA')}">Amount</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">Transfer Date</div>
                                <div class="detail-value" th:text="${#temporals.format(transfer.tanggalTransfer, 'MMM dd, yyyy HH:mm')}">Transfer Date</div>
                            </div>
                            
                            <div class="detail-item" th:if="${transfer.buktiPembayaran}">
                                <div class="detail-label">Payment Proof</div>
                                <div class="detail-value">
                                    <a th:href="@{'/uploads/payments/' + ${transfer.buktiPembayaran}}" target="_blank" class="text-blue-600 hover:underline">
                                        <i class="fas fa-external-link-alt mr-1"></i>View Proof
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Booking Timeline -->
                <div class="detail-card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-history mr-2 text-gray-600"></i>
                        Booking Timeline
                    </h2>
                    
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="font-medium">Booking Created</div>
                            <div class="text-sm text-gray-600" th:text="${#temporals.format(booking.createdAt, 'MMM dd, yyyy HH:mm')}">Created time</div>
                        </div>
                        
                        <div class="timeline-item" th:if="${booking.status.name() == 'CONFIRMED' or booking.status.name() == 'IN_PROGRESS' or booking.status.name() == 'COMPLETED'}">
                            <div class="font-medium">Booking Confirmed</div>
                            <div class="text-sm text-gray-600">Payment verified</div>
                        </div>
                        
                        <div class="timeline-item" th:if="${booking.status.name() == 'IN_PROGRESS' or booking.status.name() == 'COMPLETED'}">
                            <div class="font-medium">Service Started</div>
                            <div class="text-sm text-gray-600">Car wash service in progress</div>
                        </div>
                        
                        <div class="timeline-item" th:if="${booking.status.name() == 'COMPLETED'}">
                            <div class="font-medium">Service Completed</div>
                            <div class="text-sm text-gray-600">Car wash service finished</div>
                        </div>
                        
                        <div class="timeline-item" th:if="${booking.status.name() == 'CANCELLED'}">
                            <div class="font-medium text-red-600">Booking Cancelled</div>
                            <div class="text-sm text-gray-600" th:text="${booking.catatan ?: 'Booking was cancelled'}">Cancellation reason</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="/customer/bookings" class="btn btn-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Bookings
                    </a>
                    
                    <button th:if="${booking.status.name() == 'PENDING' or booking.status.name() == 'CONFIRMED'}"
                            class="btn btn-danger" 
                            onclick="showCancelModal()">
                        <i class="fas fa-times mr-2"></i>
                        Cancel Booking
                    </button>
                    
                    <button th:if="${booking.status.name() == 'COMPLETED'}"
                            class="btn btn-primary" 
                            onclick="window.print()">
                        <i class="fas fa-print mr-2"></i>
                        Print Receipt
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Cancel Booking Modal -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cancel Booking</h3>
                <span class="close" onclick="closeCancelModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this booking?</p>
                <div class="mt-4">
                    <label for="cancelReason" class="block text-sm font-medium text-gray-700 mb-2">
                        Reason for cancellation (optional):
                    </label>
                    <textarea id="cancelReason" rows="3" 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Enter reason for cancellation..."></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="btn btn-secondary" onclick="closeCancelModal()">
                        Keep Booking
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmCancellation()">
                        <i class="fas fa-times mr-2"></i>
                        Cancel Booking
                    </button>
                </div>
            </div>
        </div>
    </div>    <script th:inline="javascript">
        function showCancelModal() {
            document.getElementById('cancelModal').style.display = 'block';
            document.getElementById('cancelReason').value = '';
        }
        
        function closeCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
        }
        
        function confirmCancellation() {
            const bookingId = /*[[${booking.idBooking}]]*/ 'placeholder';
            const reason = document.getElementById('cancelReason').value.trim();
            const cancelBtn = document.querySelector('.modal-content .btn-danger');
            
            // Show loading state
            cancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Cancelling...';
            cancelBtn.disabled = true;
              // Send cancellation request
            fetch(`/api/booking/cancel/${bookingId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `reason=${encodeURIComponent(reason)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Booking cancelled successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to cancel booking'));
                    // Reset button
                    cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Booking';
                    cancelBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while cancelling the booking. Please try again.');
                // Reset button
                cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Booking';
                cancelBtn.disabled = false;
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('cancelModal');
            if (event.target === modal) {
                closeCancelModal();
            }
        }
    </script>

    <div th:replace="~{customer/layout :: scripts}"></div>
</body>
</html>
